var Keycode = {};
Keycode.layoutMap = {
  'arabic': {
    1642: 37, // U+066A, %
    1563: 39, // U+061B, '
    1548: 44, // U+060C, ,
    1632: 48, // U+0660, 0
    1633: 49, // U+0661, 1
    1634: 50, // U+0662, 2
    1635: 51, // U+0663, 3
    1636: 52, // U+0664, 4
    1637: 53, // U+0665, 5
    1638: 54, // U+0666, 6
    1639: 55, // U+0667, 7
    1640: 56, // U+0668, 8
    1641: 57, // U+0669, 9
    1603: 59, // U+0643, ;
    1567: 63, // U+061F, ?
    171: 65, // U+00AB, A
    1571: 66, // U+0623, B
    1574: 67, // U+0626, C
    1609: 68, // U+0649, D
    1616: 69, // U+0650, E
    1570: 72, // U+0622, H
    1617: 73, // U+0651, I
    1643: 75, // U+066B, K
    1644: 76, // U+066C, L
    1572: 77, // U+0624, M
    1573: 78, // U+0625, N
    1614: 81, // U+064E, Q
    1613: 82, // U+064D, R
    187: 83, // U+00BB, S
    1615: 84, // U+064F, T
    1618: 85, // U+0652, U
    1569: 86, // U+0621, V
    1611: 87, // U+064B, W
    1612: 89, // U+064C, Y
    1580: 91, // U+062C, [
    1577: 93, // U+0629, ]
    1600: 96, // U+0640, `
    1588: 97, // U+0634, a
    1586: 98, // U+0632, b
    1584: 99, // U+0630, c
    1610: 100, // U+064A, d
    1579: 101, // U+062B, e
    1576: 102, // U+0628, f
    1604: 103, // U+0644, g
    1575: 104, // U+0627, h
    1607: 105, // U+0647, i
    1578: 106, // U+062A, j
    1606: 107, // U+0646, k
    1605: 108, // U+0645, l
    1608: 109, // U+0648, m
    1585: 110, // U+0631, n
    1582: 111, // U+062E, o
    1581: 112, // U+062D, p
    1590: 113, // U+0636, q
    1602: 114, // U+0642, r
    1587: 115, // U+0633, s
    1601: 116, // U+0641, t
    1593: 117, // U+0639, u
    1583: 118, // U+062F, v
    1589: 119, // U+0635, w
    1591: 120, // U+0637, x
    1594: 121, // U+063A, y
    1592: 122, // U+0638, z
  },
  'russian': {
    1069: 34, // U+042D, "
    8470: 35, // U+2116, #
    1101: 39, // U+044D, '
    1073: 44, // U+0431, ,
    1102: 46, // U+044E, .
    1046: 58, // U+0416, :
    1078: 59, // U+0436, ;
    1041: 60, // U+0411, <
    1070: 62, // U+042E, >
    1060: 65, // U+0424, A
    1048: 66, // U+0418, B
    1057: 67, // U+0421, C
    1042: 68, // U+0412, D
    1059: 69, // U+0423, E
    1040: 70, // U+0410, F
    1055: 71, // U+041F, G
    1056: 72, // U+0420, H
    1064: 73, // U+0428, I
    1054: 74, // U+041E, J
    1051: 75, // U+041B, K
    1044: 76, // U+0414, L
    1068: 77, // U+042C, M
    1058: 78, // U+0422, N
    1065: 79, // U+0429, O
    1047: 80, // U+0417, P
    1049: 81, // U+0419, Q
    1050: 82, // U+041A, R
    1067: 83, // U+042B, S
    1045: 84, // U+0415, T
    1043: 85, // U+0413, U
    1052: 86, // U+041C, V
    1062: 87, // U+0426, W
    1063: 88, // U+0427, X
    1053: 89, // U+041D, Y
    1071: 90, // U+042F, Z
    1093: 91, // U+0445, [
    1105: 92, // U+0451, \
    1098: 93, // U+044A, ]
    1092: 97, // U+0444, a
    1080: 98, // U+0438, b
    1089: 99, // U+0441, c
    1074: 100, // U+0432, d
    1091: 101, // U+0443, e
    1072: 102, // U+0430, f
    1087: 103, // U+043F, g
    1088: 104, // U+0440, h
    1096: 105, // U+0448, i
    1086: 106, // U+043E, j
    1083: 107, // U+043B, k
    1076: 108, // U+0434, l
    1100: 109, // U+044C, m
    1090: 110, // U+0442, n
    1097: 111, // U+0449, o
    1079: 112, // U+0437, p
    1081: 113, // U+0439, q
    1082: 114, // U+043A, r
    1099: 115, // U+044B, s
    1077: 116, // U+0435, t
    1075: 117, // U+0433, u
    1084: 118, // U+043C, v
    1094: 119, // U+0446, w
    1095: 120, // U+0447, x
    1085: 121, // U+043D, y
    1103: 122, // U+044F, z
    1061: 123, // U+0425, {
    1025: 124, // U+0401, |
    1066: 125, // U+042A, }
  },
  'korean': {
    12600: 69, // U+3138, E
    12626: 79, // U+3152, O
    12630: 80, // U+3156, P
    12611: 81, // U+3143, Q
    12594: 82, // U+3132, R
    12614: 84, // U+3146, T
    12617: 87, // U+3149, W
    12609: 97, // U+3141, a
    12640: 98, // U+3160, b
    12618: 99, // U+314A, c
    12615: 100, // U+3147, d
    12599: 101, // U+3137, e
    12601: 102, // U+3139, f
    12622: 103, // U+314E, g
    12631: 104, // U+3157, h
    12625: 105, // U+3151, i
    12627: 106, // U+3153, j
    12623: 107, // U+314F, k
    12641: 109, // U+3161, m
    12636: 110, // U+315C, n
    12624: 111, // U+3150, o
    12628: 112, // U+3154, p
    12610: 113, // U+3142, q
    12593: 114, // U+3131, r
    12596: 115, // U+3134, s
    12613: 116, // U+3145, t
    12629: 117, // U+3155, u
    12621: 118, // U+314D, v
    12616: 119, // U+3148, w
    12620: 120, // U+314C, x
    12635: 121, // U+315B, y
    12619: 122, // U+314B, z
  },
};

Keycode.upperMap = {
  39: 34, // ', "
  44: 60, // ,, <
  45: 95, // -, _
  46: 62, // ., >
  47: 63, // /, ?
  48: 41, // 0, )
  49: 33, // 1, !
  50: 64, // 2, @
  51: 35, // 3, #
  52: 36, // 4, $
  53: 37, // 5, %
  54: 94, // 6, ^
  55: 38, // 7, &
  56: 42, // 8, *
  57: 40, // 9, (
  59: 58, // ;, :
  61: 43, // =, +
  91: 123, // [, {
  92: 124, // \, |
  93: 125, // ], }
  96: 126, // `, `~
};


// If the code can be converted, return the keyboard layout.
// Otherwise, return null.
Keycode.needConvert = function(code) {
  for (var layout in Keycode.layoutMap) {
    if (Keycode.layoutMap.hasOwnProperty(layout)) {
      if (Keycode.layoutMap[layout].hasOwnProperty(code)) {
        return layout;
      }
    }
  }
  return null;
};

Keycode.upper = function(code) {
  if (97 <= code && code <= 122) { // alphabet
    return code - 32; // to upper case
  } else if (Keycode.upperMap.hasOwnProperty(code)) {
    return Keycode.upperMap[code];
  }
  return code;
}

Keycode.convert = function(event) {
  var layout = Keycode.needConvert(event.which);
  if (layout !== null) {
    var newKeycode = Keycode.layoutMap[layout][event.which];
    if (event.shiftKey) {
      newKeycode = Keycode.upper(newKeycode);
    }

    var newEvent = document.createEvent('KeyboardEvent');
    // chromium hacks
    Object.defineProperty(newEvent, 'keyCode', {
      get : function() {
        return newKeycode;
      }
    });
    Object.defineProperty(newEvent, 'which', {
      get : function() {
        return newKeycode;
      }
    });
    newEvent.initKeyboardEvent(event.type, event.bubbles, event.cancelable, event.view, String.fromCharCode(newKeycode), event.location, event.ctrlKey, event.altKey, event.shiftKey, event.metaKey);

    return newEvent;
  }
  return event;
}
